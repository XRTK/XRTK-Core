steps:
  - powershell: |
      Write-Host "Starting ${{ parameters.target }} Build..."
      $logPath = $(LogDirectory)\${{ parameters.target }}.log
      $process = Start-Process -FilePath "$(EditorPath)" -ArgumentList "-quit -batchmode -projectPath `"$(System.DefaultWorkingDirectory)\$(project.name)`" -buildTarget ${{ parameters.target }} -executeMethod XRTK.Utilities.Build.UnityPlayerBuildTools.StartCommandLineBuild -logfile `"$logPath`"" -PassThru

      while ( -not (Test-Path $logPath -Type Leaf) ) {
          Start-Sleep -Milliseconds 100
      }

      $ljob = Start-Job -ScriptBlock { param($log) Get-Content "$log" -Wait } -ArgumentList $(LogDirectory)\$logPath

      while ( -not $process.HasExited )
      {
        Receive-Job $ljob
      }

      Receive-Job $ljob
      Stop-Job $ljob
      Remove-Job $ljob

      exit $process.ExitCode
    failOnStderr: true
    displayName: 'Build ${{ parameters.target }} Player'
