steps:
  - powershell: |
      Write-Host "Determining project version from package info..."
      $packageJsonFile = "$(System.DefaultWorkingDirectory)\$(project.name)\Packages\$(package.name)\package.json"
      $packageInfo = (Get-Content $packageJsonFile -Raw) | ConvertFrom-Json

      Write-Host "Detected Project Version:" $packageInfo.version

      Write-Host "Determining latest release version from GitHub..."
      $releases = "https://api.github.com/repos/XRTK/$(project.name)/releases"
      [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
      $oldVersionString = [string](Invoke-WebRequest -Uri $releases -UseBasicParsing | ConvertFrom-Json)[0].tag_name

      Write-Host "Detected last GitHub release: $oldVersionString"

      # Strip SemVer since version type is not compatible. We do a hard replace on the preview tag anyway.
      $version = [version] ($packageInfo.version -replace "-preview.\d*", "")
      $oldVersion = [version] ($oldVersionString -replace "-preview.\d*", "")

      if( $(isPreviewBuild) -eq 'true' ) {
        Write-Host "Update Preview Build Version"
        # if preview only bump build number if less than

        if( $version -lt $oldVersion ) {
          $version = [version]::new($oldVersion.Major, $oldVersion.Minor, $oldVersion.Build + 1)
        }
        else {
          $version = [version]::new($oldVersion.Major, $oldVersion.Minor, $oldVersion.Build)
        }
      }
      else {
        if( $(isReleaseBuild) -eq 'true' ) {
          Write-Host "Update Release Build Version"
          # if release build, then always bump build number if less than or equal

          if( $version -le $oldVersion ) {
            $version = [version]::new($oldVersion.Major, $oldVersion.Minor, $oldVersion.Build + 1)
          }
        }
        else {
          $version = [version]::new($oldVersion.Major, $oldVersion.Minor, $oldVersion.Build)
        }
      }

      Write-Host Next Release Version

      if ( $(isPreviewBuild) -eq 'true' ) {
        # 0.2.0-preview.1

        $buildNumber = $env:Build_BuildNumber
        $split = $buildNumber.Split('.')
        $revision = $split[$split.Count - 1]
        $packageInfo.version = ([string] $version) + "-preview.$revision"
        Write-Host $oldVersionString -> $packageInfo.version
      }
      else {
        Write-Host $oldVersion -> $version
        $packageInfo.version = [string] $version
      }

      Write-Host "##vso[task.setvariable variable=package.version]$($packageInfo.version)"
      $packageInfo | ConvertTo-Json | Set-Content $packageJsonFile

      Copy-Item "$(System.DefaultWorkingDirectory)\README.md" -Destination $(System.DefaultWorkingDirectory)\$(project.name)\Packages\$(package.name) -force -Verbose
      Copy-Item "$(System.DefaultWorkingDirectory)\LICENSE.md" -Destination $(System.DefaultWorkingDirectory)\$(project.name)\Packages\$(package.name) -force -Verbose
    failOnStderr: true
    displayName: 'Sync Package Info'
    condition: or( eq(variables['isReleaseBuild'], 'true'), eq(variables['isPreviewBuild'], 'true') )
