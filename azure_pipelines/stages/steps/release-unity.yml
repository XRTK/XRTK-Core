steps:
  - powershell: |
      Write-Host "Returning License..."
      $logPath = "$(LogDirectory)\deactivation.log"
      $process = Start-Process -FilePath "$(EditorPath)" -ArgumentList "-quit -batchmode -returnlicense -logfile `"$logPath`"" -PassThru

      $ljob = Start-Job -ScriptBlock {
        param($log)

        while ( (Test-Path $$log -Type Leaf) ) {
            Start-Sleep -Milliseconds 100
        }

        Get-Content "$log" -Wait
      } -ArgumentList $logPath

      while ( -not $process.HasExited )
      {
        do {
            $logOutput = Receive-Job $ljob
            $logOutput | Write-Host
        } until($logOutput.Length == 0)
      }

      do {
          $logOutput = Receive-Job $ljob
          $logOutput | Write-Host
      } until($logOutput.Length == 0)

      Stop-Job $ljob
      Remove-Job $ljob

      exit $process.ExitCode
    failOnStderr: false
    displayName: 'Return Unity License'
    condition: always()

  - task: PublishPipelineArtifact@1
    displayName: 'Publish Pipeline Artifact'
    inputs:
      targetPath: '$(project.name)/Builds'
      artifactName: 'PR Validation Build Artifacts'
    condition: always()
