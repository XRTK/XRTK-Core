steps:
  - powershell: |
      git config user.email "XRTK-Build-Bot@users.noreply.github.com"
      git config user.name "XRTK-Build-Bot"
      git status
      git add ./docs
      git add "$(System.DefaultWorkingDirectory)\$(project.name)\Packages\$(package.name)\package.json"
      git add "$(System.DefaultWorkingDirectory)\$(project.name)\Packages\$(package.name)\README.md"
      git add "$(System.DefaultWorkingDirectory)\$(project.name)\Packages\$(package.name)\LICENSE.md"
      git add "$(System.DefaultWorkingDirectory)\$(project.name)\Packages\$(package.name)\.github"
      git status
      git commit -m "release $(package.version)@$(Build.SourceVersion)"
      git checkout -b release
      git fetch origin master
      git checkout master
      git merge release
      git branch -D release
      git push https://XRTK-Build-Bot:$(GitHubPat)@github.com/$(Build.Repository.Name).git master
    displayName: 'Sync Release'

  - powershell: |
      git config user.email "XRTK-Build-Bot@users.noreply.github.com"
      git config user.name "XRTK-Build-Bot"
      git status
      git fetch origin master
      git pull origin master
      git subtree split --prefix="$(project.name)/Packages/$(package.name)" --branch upm
      $upmSha = git rev-parse upm
      Write-Host "##vso[task.setvariable variable=project.upmSha]$($upmSha)"
      git tag $(project.version) upm
      git push https://XRTK-Build-Bot:$(GitHubPat)@github.com/$(Build.Repository.Name).git upm $(project.version) --force
    displayName: 'UPM Mirror'
